#!/bin/bash

# =============================================================================\n# Torch Fellowship Backend - Docker Deployment Script for EC2\n# =============================================================================\n#\n# This script deploys the Torch Fellowship backend using Docker containers\n# on an Amazon EC2 instance.\n#\n# Prerequisites:\n# - EC2 instance with Ubuntu 20.04+ or Amazon Linux 2\n# - SSH access to the instance\n# - Docker and Docker Compose installed\n#\n# =============================================================================\n\nset -e  # Exit on any error\n\n# Colors for output\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m' # No Color\n\n# Configuration\nAPP_NAME=\"torch-fellowship-backend\"\nAPP_DIR=\"/home/ubuntu/$APP_NAME\"\nCONTAINER_NAME=\"torch-fellowship-backend\"\nIMAGE_NAME=\"torch-fellowship:latest\"\n\n# Function to print colored output\nprint_status() {\n    echo -e \"${BLUE}[INFO]${NC} $1\"\n}\n\nprint_success() {\n    echo -e \"${GREEN}[SUCCESS]${NC} $1\"\n}\n\nprint_warning() {\n    echo -e \"${YELLOW}[WARNING]${NC} $1\"\n}\n\nprint_error() {\n    echo -e \"${RED}[ERROR]${NC} $1\"\n}\n\n# Function to check if command exists\ncommand_exists() {\n    command -v \"$1\" >/dev/null 2>&1\n}\n\n# Function to install Docker\ninstall_docker() {\n    print_status \"Installing Docker...\"\n    \n    # Update package index\n    sudo apt update\n    \n    # Install required packages\n    sudo apt install -y apt-transport-https ca-certificates curl software-properties-common\n    \n    # Add Docker's official GPG key\n    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg\n    \n    # Add Docker repository\n    echo \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null\n    \n    # Update package index again\n    sudo apt update\n    \n    # Install Docker\n    sudo apt install -y docker-ce docker-ce-cli containerd.io\n    \n    # Add current user to docker group\n    sudo usermod -aG docker $USER\n    \n    # Start and enable Docker\n    sudo systemctl start docker\n    sudo systemctl enable docker\n    \n    print_success \"Docker installed successfully\"\n}\n\n# Function to install Docker Compose\ninstall_docker_compose() {\n    print_status \"Installing Docker Compose...\"\n    \n    # Get latest version of Docker Compose\n    DOCKER_COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d'\"' -f4)\n    \n    # Download Docker Compose\n    sudo curl -L \"https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)\" -o /usr/local/bin/docker-compose\n    \n    # Make it executable\n    sudo chmod +x /usr/local/bin/docker-compose\n    \n    # Create symlink\n    sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose\n    \n    print_success \"Docker Compose installed successfully\"\n}\n\n# Function to configure firewall\nconfigure_firewall() {\n    print_status \"Configuring UFW firewall...\"\n    \n    # Enable UFW\n    sudo ufw --force enable\n    \n    # Allow SSH\n    sudo ufw allow ssh\n    \n    # Allow HTTP and HTTPS\n    sudo ufw allow 80\n    sudo ufw allow 443\n    \n    # Allow application port\n    sudo ufw allow 5000\n    \n    # Show status\n    sudo ufw status\n    \n    print_success \"Firewall configured\"\n}\n\n# Function to create application directory\nsetup_app_directory() {\n    print_status \"Setting up application directory...\"\n    \n    # Create directory if it doesn't exist\n    mkdir -p $APP_DIR\n    \n    # Change to app directory\n    cd $APP_DIR\n    \n    print_success \"Application directory created at $APP_DIR\"\n}\n\n# Function to clone repository\nclone_repository() {\n    local repo_url=$1\n    \n    if [ -z \"$repo_url\" ]; then\n        print_error \"Repository URL not provided\"\n        exit 1\n    fi\n    \n    print_status \"Cloning repository from $repo_url...\"\n    \n    # Remove existing directory if it exists\n    if [ -d \"$APP_DIR/.git\" ]; then\n        print_warning \"Existing repository found, pulling latest changes...\"\n        cd $APP_DIR\n        git pull origin main\n    else\n        # Clone the repository\n        git clone $repo_url $APP_DIR\n        cd $APP_DIR\n    fi\n    \n    print_success \"Repository cloned/updated successfully\"\n}\n\n# Function to setup environment variables\nsetup_environment() {\n    print_status \"Setting up environment variables...\"\n    \n    # Copy production environment template\n    if [ -f \".env.production.template\" ]; then\n        cp .env.production.template .env\n        print_warning \"Environment file created from template. Please update with actual values!\"\n        print_warning \"Edit .env file with your production configuration:\"\n        print_warning \"  - MongoDB connection string\"\n        print_warning \"  - JWT secret\"\n        print_warning \"  - API keys\"\n        print_warning \"  - Domain configuration\"\n    else\n        print_error \"Production environment template not found!\"\n        print_warning \"Please create .env file manually with production values\"\n    fi\n}\n\n# Function to create logs directory\nsetup_logs() {\n    print_status \"Setting up logs directory...\"\n    \n    mkdir -p $APP_DIR/logs\n    \n    # Set proper permissions\n    chmod 755 $APP_DIR/logs\n    \n    print_success \"Logs directory created\"\n}\n\n# Function to build Docker image\nbuild_docker_image() {\n    print_status \"Building Docker image...\"\n    \n    cd $APP_DIR\n    \n    # Build the image\n    docker build -t $IMAGE_NAME .\n    \n    print_success \"Docker image built successfully\"\n}\n\n# Function to stop existing containers\nstop_existing_containers() {\n    print_status \"Stopping existing containers...\"\n    \n    # Stop and remove existing container if it exists\n    docker stop $CONTAINER_NAME 2>/dev/null || true\n    docker rm $CONTAINER_NAME 2>/dev/null || true\n    \n    # Stop Docker Compose if docker-compose.yml exists\n    if [ -f \"docker-compose.yml\" ]; then\n        docker-compose down 2>/dev/null || true\n    fi\n    \n    print_success \"Existing containers stopped\"\n}\n\n# Function to start application with Docker Compose\nstart_with_compose() {\n    print_status \"Starting application with Docker Compose...\"\n    \n    cd $APP_DIR\n    \n    # Start with Docker Compose\n    docker-compose up -d --build\n    \n    print_success \"Application started with Docker Compose\"\n    \n    # Show container status\n    docker-compose ps\n    docker-compose logs --tail=20\n}\n\n# Function to start application with Docker\nstart_with_docker() {\n    print_status \"Starting application with Docker...\"\n    \n    cd $APP_DIR\n    \n    # Run the container\n    docker run -d \\\n        --name $CONTAINER_NAME \\\n        --restart unless-stopped \\\n        -p 5000:5000 \\\n        --env-file .env \\\n        -v \"$APP_DIR/logs:/app/logs\" \\\n        $IMAGE_NAME\n    \n    print_success \"Application started with Docker\"\n    \n    # Show container status\n    docker ps\n    docker logs --tail=20 $CONTAINER_NAME\n}\n\n# Function to install Nginx\ninstall_nginx() {\n    print_status \"Installing and configuring Nginx...\"\n    \n    sudo apt update\n    sudo apt install -y nginx\n    \n    # Enable and start Nginx\n    sudo systemctl enable nginx\n    sudo systemctl start nginx\n    \n    print_success \"Nginx installed and started\"\n}\n\n# Function to configure Nginx reverse proxy\nconfigure_nginx_proxy() {\n    local domain=$1\n    \n    if [ -z \"$domain\" ]; then\n        print_warning \"No domain provided, skipping Nginx configuration\"\n        return\n    fi\n    \n    print_status \"Configuring Nginx reverse proxy for $domain...\"\n    \n    # Create Nginx configuration\n    sudo tee /etc/nginx/sites-available/$APP_NAME > /dev/null <<EOF\nserver {\n    listen 80;\n    server_name $domain www.$domain;\n    \n    # Security headers\n    add_header X-Frame-Options DENY;\n    add_header X-Content-Type-Options nosniff;\n    add_header X-XSS-Protection \"1; mode=block\";\n    \n    # Proxy to Docker container\n    location / {\n        proxy_pass http://localhost:5000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade \\$http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host \\$host;\n        proxy_set_header X-Real-IP \\$remote_addr;\n        proxy_set_header X-Forwarded-For \\$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \\$scheme;\n        proxy_cache_bypass \\$http_upgrade;\n        \n        # Timeouts\n        proxy_connect_timeout 60s;\n        proxy_send_timeout 60s;\n        proxy_read_timeout 60s;\n    }\n    \n    # Health check endpoint\n    location /health {\n        proxy_pass http://localhost:5000/health;\n        access_log off;\n    }\n    \n    # WebSocket support for Socket.IO\n    location /socket.io/ {\n        proxy_pass http://localhost:5000;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade \\$http_upgrade;\n        proxy_set_header Connection \"upgrade\";\n        proxy_set_header Host \\$host;\n        proxy_set_header X-Real-IP \\$remote_addr;\n        proxy_set_header X-Forwarded-For \\$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \\$scheme;\n    }\n}\nEOF\n    \n    # Enable the site\n    sudo ln -sf /etc/nginx/sites-available/$APP_NAME /etc/nginx/sites-enabled/\n    \n    # Remove default site\n    sudo rm -f /etc/nginx/sites-enabled/default\n    \n    # Test Nginx configuration\n    sudo nginx -t\n    \n    # Reload Nginx\n    sudo systemctl reload nginx\n    \n    print_success \"Nginx reverse proxy configured for $domain\"\n}\n\n# Function to install SSL certificate with Let's Encrypt\nsetup_ssl() {\n    local domain=$1\n    \n    if [ -z \"$domain\" ]; then\n        print_warning \"No domain provided, skipping SSL setup\"\n        return\n    fi\n    \n    print_status \"Setting up SSL certificate with Let's Encrypt...\"\n    \n    # Install Certbot\n    sudo apt update\n    sudo apt install -y certbot python3-certbot-nginx\n    \n    # Obtain SSL certificate\n    sudo certbot --nginx -d $domain -d www.$domain --non-interactive --agree-tos --email admin@$domain\n    \n    # Set up automatic renewal\n    sudo systemctl enable certbot.timer\n    \n    print_success \"SSL certificate installed and auto-renewal configured\"\n}\n\n# Function to run health check\nrun_health_check() {\n    print_status \"Running health check...\"\n    \n    # Wait a moment for the application to start\n    sleep 15\n    \n    # Check if application is responding\n    if curl -f http://localhost:5000/health > /dev/null 2>&1; then\n        print_success \"Health check passed - application is running!\"\n    else\n        print_error \"Health check failed - application may not be running properly\"\n        print_status \"Checking container logs...\"\n        \n        if [ -f \"docker-compose.yml\" ]; then\n            docker-compose logs --tail=20\n        else\n            docker logs --tail=20 $CONTAINER_NAME\n        fi\n    fi\n}\n\n# Function to display post-deployment information\nshow_deployment_info() {\n    local domain=$1\n    \n    print_success \"==============================================================================\"\n    print_success \"Docker deployment completed successfully!\"\n    print_success \"==============================================================================\"\n    \n    if [ -n \"$domain\" ]; then\n        print_success \"Your application is available at:\"\n        print_success \"  - https://$domain\"\n        print_success \"  - https://www.$domain\"\n    else\n        local public_ip=$(curl -s http://checkip.amazonaws.com)\n        print_success \"Your application is available at:\"\n        print_success \"  - http://$public_ip:5000\"\n    fi\n    \n    print_success \"\"\n    print_success \"Useful Docker commands:\"\n    if [ -f \"docker-compose.yml\" ]; then\n        print_success \"  - Check status: docker-compose ps\"\n        print_success \"  - View logs: docker-compose logs -f\"\n        print_success \"  - Restart: docker-compose restart\"\n        print_success \"  - Stop: docker-compose down\"\n    else\n        print_success \"  - Check status: docker ps\"\n        print_success \"  - View logs: docker logs -f $CONTAINER_NAME\"\n        print_success \"  - Restart: docker restart $CONTAINER_NAME\"\n        print_success \"  - Stop: docker stop $CONTAINER_NAME\"\n    fi\n    print_success \"  - Check health: curl http://localhost:5000/health\"\n    print_success \"\"\n    print_warning \"Don't forget to:\"\n    print_warning \"  1. Update your .env file with production values\"\n    print_warning \"  2. Configure your domain's DNS to point to this server\"\n    print_warning \"  3. Set up monitoring and backups\"\n    print_warning \"  4. Configure log rotation for Docker logs\"\n    print_success \"==============================================================================\"\n}\n\n# Main deployment function\nmain() {\n    local repo_url=$1\n    local domain=$2\n    \n    print_status \"Starting Torch Fellowship Backend Docker deployment...\"\n    \n    # Check if running as ubuntu user\n    if [ \"$USER\" != \"ubuntu\" ]; then\n        print_error \"This script should be run as the ubuntu user\"\n        exit 1\n    fi\n    \n    # Update system\n    print_status \"Updating system packages...\"\n    sudo apt update && sudo apt upgrade -y\n    \n    # Install Docker and Docker Compose if not present\n    if ! command_exists docker; then\n        install_docker\n        # Need to log out and back in for docker group changes\n        print_warning \"Please log out and back in, then run this script again\"\n        exit 0\n    fi\n    \n    if ! command_exists docker-compose; then\n        install_docker_compose\n    fi\n    \n    if ! command_exists nginx; then\n        install_nginx\n    fi\n    \n    # Configure firewall\n    configure_firewall\n    \n    # Setup application\n    setup_app_directory\n    \n    if [ -n \"$repo_url\" ]; then\n        clone_repository $repo_url\n    else\n        print_error \"Repository URL not provided\"\n        print_status \"Usage: $0 <repository_url> [domain]\"\n        exit 1\n    fi\n    \n    setup_environment\n    setup_logs\n    \n    # Stop any existing containers\n    stop_existing_containers\n    \n    # Build and start with Docker\n    if [ -f \"docker-compose.yml\" ]; then\n        start_with_compose\n    else\n        build_docker_image\n        start_with_docker\n    fi\n    \n    # Configure Nginx if domain provided\n    if [ -n \"$domain\" ]; then\n        configure_nginx_proxy $domain\n        setup_ssl $domain\n    fi\n    \n    run_health_check\n    \n    show_deployment_info $domain\n}\n\n# Run main function with all arguments\nmain \"$@\"